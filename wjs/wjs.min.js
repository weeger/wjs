(function(g){g.wjsContext=g;var f=function(a){this.options=a=this.extendOptions(a);g[a.settings?a.settings.clientName:"wjs"]=this;"loading"!==this.document.readyState?this.init():this.window.addEventListener("load",this.init.bind(this))};f.prototype={context:g,window:g.window||window,document:g.document||window.document,init:function(){var a=this,b=a.options;a.extendObject(a,{version:b.settings?b.settings.version:"[$version]-headless",readyComplete:!1,packageDefault:{},loaders:{},loadersBasic:[],
extLoaded:{WjsLoader:{}},extRequire:{WjsLoader:{}},classMethods:{},classProtos:{},processes:{},processCounter:0,stack:[],stackCurrent:!1,cacheReg:{},settings:{clientName:"",paramExtra:"",paramInc:"",paramExc:"",paramToken:"",pathResponse:"",cacheToken:""}});a.extendObject(a,b);a.classExtend("WjsLoader",f.lib.Loader);a.classExtend("WjsProcess",f.lib.Process);a.classExtend("Stack",f.lib.Stack);a.loaderAdd("JsLink",f.retrieve("WjsLoader","JsLink"),!0);a.loaderAdd("WjsLoader",f.retrieve("WjsLoader","WjsLoader"),
!0);for(var c=0,d;d=a.loadersBasic[c++];)a.loaderAdd(d,void 0,!0);a.async=a.window.setTimeout.bind(a.window);a.use(null,{response:a.packageDefault,complete:function(){var c=f.readyCallbacks[a.settings.clientName];a.readyComplete=!0;b.complete&&b.complete.call(a);c&&a.callbacks(c)}})},callbacks:function(a,b,c){for(var d=b?"apply":"call",e,h=0;e=a[h++];)e[d](c||this,b)},urlToken:function(a){var b=this.settings.cacheToken;return b?(-1===a.indexOf("?")?a+"?":a)+"&"+b:a},loaderAdd:function(a,b,c,d){var e=
this,h="WjsLoader"+a;b=b||{};e.loaders[a]||(b.type=a,b.classExtends="WjsLoader"+(b.loaderExtends||""),b.loaderExtends?e.loadersExists([b.loaderExtends],function(){e.loaderBuild(a,h,b,c,d)}):e.loaderBuild(a,h,b,c,d))},loaderBuild:function(a,b,c,d,e){this.classExtend(b,c);this.loaders[a]=new (this.classProto(b))(a);this.extRequire[a]={};b=this.extLoaded;b[a]=b[a]||{};d&&(b.WjsLoader[a]=c);e&&e()},loadersExists:function(a,b){for(var c=0,d=[],e;e=a[c++];)this.loaders[e]||d.push(e);return d.length?this.use({WjsLoader:d},
{stack:!1,complete:b}):b()},process:function(a,b){return new (this.classProto("WjsProcess"))(a,b,this)},use:function(a,b){var c=this.extendArgs(arguments);c[1]&&(c[1].async=!1!==c[1].async);return this.process(c[0],c[1])},get:function(a,b){var c=this.extLoaded[a];return c&&c.hasOwnProperty(b)?c[b]:!1},destroy:function(a,b,c){var d=this,e=d.extendArgs(arguments),h=e[0];c=e[1];"boolean"===typeof c&&(c={});c=d.extendObject({destroy:!0,dependencies:!0===arguments[1]||!0===arguments[2]},d.extendOptions(c));
c.async=!0===c.async;if(h.WjsLoader&&1<Object.keys(h).length){var k={WjsLoader:h.WjsLoader},e=this.extendObject({},c);e.complete=function(){d.destroy(k,c)};delete h.WjsLoader;return this.destroy(h,e)}return d.process(h,c)},extIsCore:function(a,b){return"WjsLoader"===a&&("WjsLoader"!==b||"JsLink"!==b||-1!==this.loadersBasic.indexOf(b))},requirementsDeletable:function(a,b){var c={},d=this.extRequire[a][b];d&&this.regEach(d,function(d,h){this.extIsCore(d,h)||this.requireShared(a,b,d,h,c)||(c[d]=c[d]||
[],c[d].push(h))});return c},requireShared:function(a,b,c,d,e){var h=this,k=!1;h.regEach(h.extRequire,function(f,m){var g=h.extRequire[f][m];if(f!==a&&m!==b&&g[c]&&!(-1===g[c].indexOf(d)||e&&e[f]&&-1!==e[f].indexOf(m)))return k=!0,!1});return k},regEach:function(a,b){for(var c=0,d,e,h,f=Object.keys(a),g;e=f[c++];)for(g=Array.isArray(a[e])?a[e]:Object.keys(a[e]),d=0;h=g[d++];)if(!1===b.call(this,e,h))return!1;return!0},regRem:function(a,b,c){delete a[b][c];this.objectIsEmpty(a[b])&&delete a[b]},regNext:function(a){var b=
Object.keys(a)[0],c;return b&&(c=Object.keys(a[b])[0])?{type:b,name:c,data:a[b][c]}:!1},ajax:function(a){var b=new this.window.XMLHttpRequest,c=a.data?this.param(a.data):void 0,d=a.method||"GET",e=a.success,h=a.url;b.open(d,"GET"===d&&c?h+"?"+c:h,void 0!==a.async?a.async:!0);b.onreadystatechange=function(){4===b.readyState&&(200===b.status?e&&"function"===typeof e&&e(b):a.error&&a.error(b))};"POST"===d&&b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(c)},param:function(a){for(var b=
0,c=[],d,e=Object.keys(a);d=e[b++];)c.push(d+"="+a[d]);return c.join("&")},extendObject:function(a,b,c){for(var d=0,e,h=Object.keys(b),f;e=h[d++];)f=b[e],c&&"object"===typeof f&&null!==f?(a[e]=a[e]||(Array.isArray(f)?[]:{}),this.extendObject(a[e],f)):a[e]=f;return a},extendArgs:function(a){var b=a[0],c=a[1],d={};"string"===typeof b&&(d[b]=[c],b=d,c=a[2]);return[b,c]},extendOptions:function(a){a?"function"===typeof a&&(a={complete:a}):a={};return a},extendProto:function(a,b){for(var c=0,d=Object,e,
h=d.keys(b);e=h[c++];)d.defineProperty(a,e,d.getOwnPropertyDescriptor(b,e));return a},objectIsEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},classExtend:function(a,b){var c=this.classMethods;c[a]?this.extendProto(c[a],b):c[a]=b;delete this.classProtos[a]},classProto:function(a){var b=this.classProtos,c=this.classMethods[a];if(!b[a]){var d,e=Object;(d=c&&c.classExtends?c.classExtends:!1)&&(e=this.classProto(d));d=b[a]=function(){var a=this.__construct;a&&(arguments.length?
a.apply(this,arguments):a.call(this))};d.prototype=Object.create(e.prototype);d.prototype.constructor=e;d.prototype.className=a;d.prototype.wjs=this;c&&this.extendProto(b[a].prototype,c)}return b[a]},classProtoDestroy:function(a,b){var c=this.classProtos,d=this.classMethods;c[a]&&delete c[a];!b&&d[a]&&delete d[a]},onload:function(a,b){var c=!1,d=function(){c||(c=!0,a.removeEventListener("load",d),b())};a.addEventListener("load",d);this.async(d,200)},err:function(a,b){var c=this.window.console,d="["+
this.settings.clientName+" error] : ";if(!b&&c)c.error(d+a);else throw new this.window.Error(d+a);}};f.lib={};f.reg={};f.readyCallbacks={};f.context=g;f.ready=function(a,b){var c=this.readyCallbacks;"function"===typeof a&&(b=a,a="wjs");g[a]&&!0===g[a].readyComplete?g[a].async(b):(c[a]=c[a]||[],c[a].push(b))};f.trigger=function(a,b){var c=g.window,d=c.document.createEvent("CustomEvent");d.initCustomEvent(a,!0,!0,b||null);c.dispatchEvent(d)};f.listenOnce=function(a,b){var c=function(){g.window.removeEventListener(a,
c);b()};g.window.addEventListener(a,c)};f.register=function(a,b,c){var d=this.reg;d[a]=d[a]||{};d[a][b]=c;f.trigger("wjsRegister::"+a+"::"+b)};f.retrieve=function(a,b){var c=this.reg;return c[a]&&c[a][b]?c[a][b]:!1};f.registerListen=function(a,b,c){var d=this,e=f.retrieve(a,b);e?c(e):f.listenOnce("wjsRegister::"+a+"::"+b,function(){c(d.reg[a][b])})};f.cache=function(a,b,c){f.register("cache",a+"/"+b,c)};f._e=function(){};g.WjsProto=f;f.lib.Loader={type:"",preventReload:!0,processType:"server",__construct:function(){f.reg.WjsLoader[this.type]=
f.reg.WjsLoader[this.type]||{}},__destruct:f._e,parse:function(a,b,c){this.enable(a,b,c);return b},register:f._e,link:function(a){this.wjs.use(this.type,a)},destroy:function(a,b){this.disable(a,b);return!0},enable:f._e,disable:f._e,requestUse:function(a,b){return{mode:this.processType,type:this.type,name:a}},requestDestroy:function(a,b){return{mode:"parse",type:this.type,name:a}},registerListen:function(a,b,c){var d=this;f.registerListen(a,b,function(){d.register.call(d,a,b,c)})}};f.lib.Process={phase:0,
phases:["bootIsReload","bootRequestFilter","bootGetLoaders","bootFilterLoaders","processStart"],__construct:function(a,b){var c=this.wjs;b=c.extendOptions(b);c.extendObject(this,{id:c.processCounter++,request:a||{},destroy:b.destroy||!1,async:!1!==b.async,options:b,response:b.response||{},parseQ:{},callbacks:b.complete?[b.complete]:[],exclude:b.exclude,stack:!1===b.stack?!1:b.stack||c.stackCurrent||c.stack,stackInternal:[],output:{},reboot:this.boot.bind(this),responseParseNextProxy:this.responseParseNext.bind(this)});
c.processes[this.id]=this;this.stack?(this.stack.push(this),this.stack.started||(this.stack.started=!0,this.stackNext())):this.boot()},boot:function(){this.phase=this.phase||0;this[this.phases[this.phase]]()&&(this.phase++,this.boot())},bootIsReload:function(){return this.options.reload?(this.phase++,this.wjs.destroy(this.request,{stack:!1,complete:this.reboot}),!1):!0},bootRequestFilter:function(){var a=this,b=a.wjs,c={};if(b.regEach(this.request,function(d,e){var f=0,k,g;g=a.output;if((k=b.get(d,
e))&&!a.destroy)g[d]=g[d]||{},g[d][e]=k;else{for(g=Object.keys(b.processes);k=g[f++];)if(k=b.processes[k],!Object.isFrozen(k)&&k.destroy===a.destroy&&k.parseQ[d]&&k.parseQ[d][e])return k.itemProcess(d,e,a.reboot),!1;c[d]=c[d]||[];c[d].push(e)}}))return this.request=c,!0},bootGetLoaders:function(){this.phase++;this.wjs.loadersExists(Object.keys(this.request),this.reboot)},bootFilterLoaders:function(){for(var a={},b=Object.keys(this.request),c,d=0;c=b[d++];)this.wjs.loaders[c]&&(a[c]=this.request[c]);
this.request=a;return!0},processStart:function(){var a=this,b=a.wjs,c=0,d,e={},f=this.response,k=b.settings,g="request"+(a.destroy?"Destroy":"Use");b.regEach(this.request,function(c,l){var n=b.loaders[c][g](l,a);switch(n.mode){case "server":d=k.paramInc+"["+c+"]";e[d]=e[d]?e[d]+","+l:l;break;case "parse":f[c]=f[c]||{},f[c][l]={"#data":n.data}}});if(b.objectIsEmpty(e))a.responseParse(f);else{if(a.exclude)if(!0===a.exclude)e[k.paramExc]="1";else for(d=Object.keys(a.exclude),c=0;c<d.length;c++)e[k.paramExc+
"["+d[c]+"]"]=a.exclude[d[c]].join(",");k.cacheToken&&(e[k.paramToken]=k.cacheToken);b.ajax({url:k.pathResponse+"?"+b.param(e)+k.paramExtra,method:"GET",success:function(c){b.extendObject(f,JSON.parse(c.responseText),!0);a.responseParse(f)}})}},responseParse:function(a){var b=this,c=b.wjs,d=b.parseQ;c.extendObject(d,a,!0);c.loadersExists(Object.keys(d),function(){b.async?c.async(b.responseParseNextProxy):b.responseParseNext()})},responseParseNext:function(){var a,b=this.parseQ;(a=this.wjs.regNext(b))?
this.itemProcess(a.type,a.name):(0<Object.keys(b).length&&this.wjs.err("Parse queue not empty."),this.processComplete())},itemProcess:function(a,b,c){var d=this.parseQ[a][b];c&&(d["#callback"]=c);if(this.destroy)this.itemDestroy(a,b);else if(!1===this.wjs.get(a,b))this.itemParse(a,b,d);else return this.itemProcessComplete(a,b),!1;return!0},itemParse:function(a,b,c){var d=this,e=d.wjs,h=e.extRequire,k=d.parseQ,g=function(){d.itemParse(a,b,c)};h[a][b]=h[a][b]||{};if(c["#require"]&&(e.extendObject(h[a][b],
c["#require"]),d.requireMissing(c["#require"]))){e.regEach(c["#require"],function(a,b){if(k[a]&&k[a][b])return e.loadersExists([a],function(){d.itemProcess(a,b,g)}),!1})&&(c["#require"]=void 0,e.use(c["#require"],{stack:!1,complete:g}));return}"string"===typeof c["#data"]&&0===c["#data"].indexOf("cache://")?(e.cacheReg[a+"::"+b]=c["#data"].split("://")[1],f.registerListen("cache",a+"/"+b,function(e){c["#data"]=e;d.itemParseSave(a,b,e)})):d.itemParseSave(a,b,c["#data"])},itemParseSave:function(a,b,
c){var d=this.wjs,e=d.loaders[a];"string"===typeof c&&0===c.indexOf("WJS_ERR_")?(d.err("Parse error for "+a+"::"+b+" : "+c),c=new d.window.Error(c)):c=e.parse(b,c,this);!1!==c&&this.itemParseComplete(a,b,c)},itemParseComplete:function(a,b,c){var d=this.output,e=this.wjs.extLoaded;e[a]&&(e[a][b]=c,d[a]=d[a]||{},d[a][b]=c);this.itemProcessComplete(a,b)},itemDestroy:function(a,b){var c=this.wjs.get(a,b),d=this.wjs.loaders[a];d&&!1!==c&&!1===d.destroy(b,c,this)||this.itemDestroyComplete(a,b)},itemDestroyComplete:function(a,
b){var c=this,d=c.wjs,e=a+"::"+b,f=d.cacheReg[e],g=c.options.dependencies?d.requirementsDeletable(a,b):!1;delete d.extRequire[a][b];delete d.extLoaded[a][b];f&&(d.extendObject(g,d.requirementsDeletable("CacheLink",f)),delete c.wjs.cacheReg[e]);g&&Object.keys(g).length?d.destroy(g,{stack:!1,dependencies:!0,complete:function(){c.itemDestroyComplete(a,b)}}):this.itemProcessComplete(a,b)},itemProcessComplete:function(a,b){var c=this.wjs,d=this.parseQ[a][b]["#callback"];this.wjs.regRem(this.parseQ,a,b);
d?c.async(d):this.responseParseNext()},processComplete:function(){var a=this.wjs;delete a.processes[this.id];Object.freeze(this);if(this.callbacks.length){var b=a.stackCurrent;a.stackCurrent=this.stackInternal;a.callbacks(this.callbacks,[this.output,this]);a.stackCurrent=b}this.stack&&this.stackNext()},requireMissing:function(a){var b=!1;this.wjs.regEach(a,function(a,d){if(!1===this.get(a,d))return b=!0,!1});return b},stackNext:function(){this.stack.length?this.stack.shift().boot():this.stack.started=
!1}};f.register("WjsLoader","JsLink",{processType:"parse",parse:function(a,b,c){if("WJS_PUSH_JSLINK_INCLUDED"===b)return this.wjs.document.head.querySelector('script[src="'+a+'"]')||!0;var d=this,e=d.wjs,f=e.document.createElement("script");b=e.urlToken(b||a);return b instanceof e.window.Error?!0:(e.onload(f,function(){d.parseLinkLoaded(a,f,c)}),d.enable(a,f),f.setAttribute("src",b),!1)},enable:function(a,b){this.wjs.document.head.appendChild(b)},disable:function(a,b){b.parentNode&&b.parentNode.removeChild(b)},
parseLinkLoaded:function(a,b,c){c.itemParseComplete(this.type,a,b)}});f.register("WjsLoader","WjsLoader",{loaderExtends:"JsLink",processType:"server",destroy:function(a,b){var c=this.wjs,d=c.loaders;d[a]&&(d[a].__destruct(),c.classProtoDestroy("WjsLoader"+a),delete d[a],delete c.extLoaded[a],delete c.extRequire[a]);return d.JsLink.destroy.call(this,a,b)},parse:function(a,b,c){var d=this.wjs;if(!0===b)return d.loaderAdd(a),!0;this.registerListen(this.type,a,c);d.loaders.JsLink.parse.call(this,a,b,
c);return!1},parseLinkLoaded:function(a,b,c){},register:function(a,b,c){a=f.retrieve(this.type,b);this.wjs.loaderAdd(b,a);c.itemParseComplete(this.type,b,a)}})})(this);
